<!--
Copyright (C) Sam Parkinson 2014

This file is part of ASLO.

ASLO is free software: you can redistribute it and/or modify it under
the terms of the GNU Affero General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

ASLO is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with ASLO.  If not, see <http://www.gnu.org/licenses/>.
-->

<!DOCTYPE html>
<html>
  <head>
    <title i18n-content>Sugar Activities</title>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta name="viewport" content="width=device-width">
    <meta charset="utf-8">
    <style></style>
    <!-- Eaiser JS Debugging
      <script src="/main.js"></script>
    -->
  </head>
  <body>
    <p>Loading...</p>
    <p>Cargando...</p>
    <p style="font-weight:bold;" id="prog">0%</p>

    <script>
var l = localStorage;
var xhr = new XMLHttpRequest();

function insertCache() {
    document.querySelector('body').innerHTML = l.html;
    document.querySelector('head style').innerHTML = l.css;
    // Comment the following for eaiser debugging
    f = new Function(l.js);
    f();
}

function xhrLoad(e) {
    if (xhr.readyState === 4 || xhr.status === 200) {
        var d = xhr.responseText;
        lens = [parseInt(d.substr(0, 7)), parseInt(d.substr(7, 7)),
                parseInt(d.substr(14, 7)), parseInt(d.substr(21, 7))];

        var i = 0;
        while (true) {
            try {
                l.js = d.substr(7*4, lens[0]);
                l.css = d.substr(7*4+lens[0], lens[1]);
                console.log( d.substr(7*4+lens[0], lens[1]).length);
                l.html = d.substr(7*4+lens[0]+lens[1], lens[2]);
                l.data = d.substr(7*4+lens[0]+lens[1]+lens[2], lens[3]);
                l.hasCache = 'true';
                break;
            } catch (e) {
                // No more local storage space :(
                console.log(e);
                l.clear();
            }
            i++;
            if (i === 5) {
                document.body.innerHTML =
                    '<p>Attempted to set localStorage 5 times, errors all \
                        times</p> \
                     <p><pre>' + e + '</pre></p>';
                return;
            }
        }
        insertCache();
    }
}

function updateProgress (e) {
    if (e.lengthComputable) {
        var p = Math.round((e.loaded / e.total) * 100).toString() + '%';
        document.querySelector('#prog').innerHTML = p;
    };
};

if (l.hasCache === 'true') {
    insertCache();
} else {
    xhr.open('GET', '/bundle');
    xhr.onload = xhrLoad;
    xhr.onprogress = updateProgress;
    xhr.onerror = function(e) {document.body.innerHTML = '<p>Error</p>'};
    xhr.send(null);
}
    </script>
  </body>
</html>
